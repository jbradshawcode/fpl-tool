<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FPL Expected Points Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .position-selector {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .selector-row-toggles {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            cursor: pointer;
            user-select: none;
        }

        .toggle-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .pill-toggle {
            display: flex;
            align-items: center;
            width: 72px;
            height: 32px;
            border-radius: 999px;
            background: #667eea;
            cursor: pointer;
            padding: 3px;
            transition: background 0.25s;
            flex-shrink: 0;
            user-select: none;
        }

        .pill-toggle[data-on="false"] {
            background: #ced4da;
        }

        .pill-knob {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            transition: transform 0.25s;
            flex-shrink: 0;
        }

        .pill-toggle[data-on="true"] .pill-knob {
            transform: translateX(40px);
        }

        .pill-label {
            position: absolute;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            pointer-events: none;
            margin-left: 8px;
            transition: opacity 0.2s;
        }

        .pill-toggle[data-on="false"] .pill-label {
            margin-left: 30px;
            color: #6c757d;
        }

        .selector-row-dropdowns {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: nowrap;
        }

        .selector-row-sliders label {
            white-space: nowrap;
            width: 100px;
            flex-shrink: 0;
        }

        .selector-row-sliders {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: nowrap;
        }

        .selector-row-sliders.is-expanded {
            gap: 1rem;
        }

        .selector-row-sliders.is-expanded .slider-value {
            min-width: 70px;
        }

        .selector-item--stacked {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }

        .stacked-slider {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .selector-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1 1 0;
            min-width: 0;
        }

        .selector-item.selector-item--pill {
            flex: 0 0 auto;
            min-width: 0;
        }

        .position-selector label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        select.filter-select {
            padding: 0.65rem 1rem;
            font-size: 0.95rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        select.filter-select:hover {
            border-color: #667eea;
        }

        select.filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 150px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #dee2e6 0%, #667eea 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #5568d3;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: #5568d3;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .slider-value {
            font-weight: 700;
            color: #667eea;
            font-size: 0.95rem;
            min-width: 75px;
            text-align: right;
            white-space: nowrap;
        }

        .position-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .position-title {
            color: #667eea;
            font-size: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
            margin: 0;
        }

        .player-count {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1rem;
        }

        .page-btn {
            background: white;
            color: #667eea;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .page-btn:hover:not(.disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .page-btn.disabled {
            background: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .page-info {
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background-color: #e9ecef;
        }

        .sort-arrow {
            margin-left: 0.25rem;
            color: #667eea;
            font-size: 0.8rem;
        }

        th.numeric {
            text-align: right;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        td.numeric {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .player-name {
            font-weight: 500;
            color: #212529;
        }

        .team-name {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .rank {
            font-weight: 600;
            color: #667eea;
        }

        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            h1 { font-size: 1.5rem; margin-bottom: 1rem; }
            .position-selector { padding: 1rem; }
            .selector-row-dropdowns { gap: 1rem; }
            .selector-row-sliders { gap: 1rem; flex-wrap: wrap; }
            .selector-item { flex: 1 1 0; min-width: 0; gap: 0.5rem; }
            .position-selector label { font-size: 0.8rem; }
            select.filter-select { padding: 0.5rem 0.75rem; font-size: 0.85rem; min-width: 0; }
            .slider-container { min-width: 0; flex: 1; gap: 0.5rem; }
            input[type="range"] { height: 10px; }
            input[type="range"]::-webkit-slider-thumb { width: 28px; height: 28px; }
            input[type="range"]::-moz-range-thumb { width: 28px; height: 28px; }
            .slider-value { font-size: 0.85rem; min-width: 65px; }
            .position-section { padding: 1rem; }
            .position-title { font-size: 1.2rem; }
            .player-count { font-size: 0.75rem; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.4rem 0.2rem; }
            .pagination { flex-wrap: nowrap; gap: 0.5rem; padding: 0.75rem; }
            .page-btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
            .page-info { font-size: 0.85rem; }
        }

        @media (max-width: 926px) and (orientation: landscape) {
            body { padding: 0.5rem; }
            h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
            .position-selector { padding: 0.5rem 0.75rem; }
            .selector-row-dropdowns { gap: 0.5rem; margin-bottom: 0.5rem; }
            .selector-row-sliders { gap: 0.5rem; }
            .selector-item { min-width: 0; flex: 1 1 0; gap: 0.35rem; }
            .position-selector label { font-size: 0.7rem; }
            select.filter-select { font-size: 0.75rem; padding: 0.35rem 0.5rem; min-width: 80px; }
            .slider-container { min-width: 0; flex: 1; gap: 0.35rem; }
            input[type="range"] { height: 8px; min-width: 50px; }
            input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
            input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; }
            .slider-value { font-size: 0.75rem; min-width: 55px; }
            .position-section { padding: 0.75rem; }
            .position-title { font-size: 1rem; }
            .player-count { font-size: 0.7rem; }
            table { font-size: 0.7rem; }
            th, td { padding: 0.35rem 0.15rem; }
            .pagination { padding: 0.5rem; margin: 0.75rem 0; }
            .page-btn { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
            .page-info { font-size: 0.8rem; }
        }

        @media (max-width: 576px) {
            .selector-row-dropdowns,
            .selector-row-sliders { flex-direction: column; align-items: stretch; gap: 0.75rem; }
            .selector-item { flex-direction: row; align-items: center; min-width: 100%; justify-content: space-between; }
            .position-selector label { flex-shrink: 0; }
            select.filter-select { flex: 1; }
            .slider-container { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚽ FPL Expected Points Analysis</h1>
        
        <!-- Filters -->
        <div class="position-selector">

            <!-- Row 1: Dropdowns + Toggle (left-aligned) -->
            <div class="selector-row-dropdowns">

                <div class="selector-item">
                    <label for="position-dropdown">Position:</label>
                    <select id="position-dropdown" class="filter-select" onchange="applyFilters()">
                        <option value="" {% if selected_position == '' %}selected{% endif %}>All Positions</option>
                        {% for pos_code, pos_name in all_positions.items() %}
                        <option value="{{ pos_code }}" {% if pos_code == selected_position %}selected{% endif %}>
                            {{ pos_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="selector-item">
                    <label for="team-dropdown">Team:</label>
                    <select id="team-dropdown" class="filter-select" onchange="applyFilters()">
                        <option value="">All Teams</option>
                        {% for team in all_teams %}
                        <option value="{{ team }}" {% if team == selected_team %}selected{% endif %}>{{ team }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="selector-item selector-item--pill">
                    <label for="adjust-difficulty-toggle">Adjust for Fixture Difficulty:</label>
                    <div class="pill-toggle" id="adjust-difficulty-toggle" onclick="toggleFutureWindow(this)" data-on="{{ 'true' if adjust_difficulty else 'false' }}">
                        <div class="pill-knob"></div>
                        <span class="pill-label">{{ 'On' if adjust_difficulty else 'Off' }}</span>
                    </div>
                </div>

            </div>

            <!-- Row 2: Sliders -->
            <div class="selector-row-sliders is-expanded">

                <div class="selector-item">
                    <label for="mins-slider">Mins Played:</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            id="mins-slider" 
                            min="0" max="100" step="1" 
                            value="{{ mins_threshold }}"
                            oninput="updateLabel('mins-value', this.value + '%'); scheduleApply()"
                        >
                        <span class="slider-value" id="mins-value">{{ mins_threshold }}%</span>
                    </div>
                </div>

                <div class="selector-item">
                    <label for="price-slider">Max Price:</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            id="price-slider" 
                            min="{{ global_price_min }}" max="{{ global_price_max }}" step="0.1" 
                            value="{{ price_max }}"
                            oninput="updateLabel('price-value', '£' + parseFloat(this.value).toFixed(1) + 'm'); scheduleApply()"
                        >
                        <span class="slider-value" id="price-value">£{{ "%.1f"|format(price_max) }}m</span>
                    </div>
                </div>

                <div class="selector-item">
                    <label for="games-slider">Recency:</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            id="games-slider" 
                            min="1" max="{{ max_games }}" step="1" 
                            value="{{ time_period }}"
                            oninput="updateGamesLabel(this.value); scheduleApply()"
                        >
                        <span class="slider-value" id="games-value">{{ time_period }}{% if time_period == 1 %} Game{% else %} Games{% endif %}{% if time_period == max_games %} (All){% endif %}</span>
                    </div>
                </div>

                <div class="selector-item" id="future-window-item" style="display: {{ 'flex' if adjust_difficulty else 'none' }};">
                    <label for="future-slider">Horizon:</label>
                    <div class="slider-container">
                        <input
                            type="range"
                            id="future-slider"
                            min="1" max="{{ max_games }}" step="1"
                            value="{{ horizon }}"
                            oninput="updateLabel('future-value', this.value + (this.value == 1 ? ' Game' : ' Games')); scheduleApply()"
                        >
                        <span class="slider-value" id="future-value">{{ horizon }} {{ 'Game' if horizon == 1 else 'Games' }}</span>
                    </div>
                </div>

            </div>

            </div>

        </div>
        
        <!-- Results -->
        <div class="position-section">
            <div class="section-header">
                <h2 class="position-title">{{ position_data.name }}</h2>
                <p class="player-count">Showing {{ position_data.start_rank }}–{{ position_data.end_rank }} of {{ position_data.total_players }} players</p>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th class="sortable" onclick="sortTable('web_name')">
                                Player{% if sort_by == 'web_name' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="sortable" onclick="sortTable('team_name')">
                                Team{% if sort_by == 'team_name' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('now_cost')">
                                Cost{% if sort_by == 'now_cost' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('percentage_of_mins_played')">
                                Mins %{% if sort_by == 'percentage_of_mins_played' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('expected_points')">
                                xP{% if sort_by == 'expected_points' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('actual_points')">
                                AP{% if sort_by == 'actual_points' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('expected_points_per_90')">
                                xP/90{% if sort_by == 'expected_points_per_90' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                            <th class="numeric sortable" onclick="sortTable('actual_points_per_90')">
                                AP/90{% if sort_by == 'actual_points_per_90' %}<span class="sort-arrow">{{ '▼' if sort_order == 'desc' else '▲' }}</span>{% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in position_data.players %}
                        <tr>
                            <td class="rank">{{ player.rank|int }}</td>
                            <td class="player-name">{{ player.web_name }}</td>
                            <td class="team-name">{{ player.team_name }}</td>
                            <td class="numeric">£{{ "%.1f"|format(player.now_cost) }}m</td>
                            <td class="numeric">{{ "%.2f"|format(player.percentage_of_mins_played) }}%</td>
                            <td class="numeric">{{ "%.2f"|format(player.expected_points) }}</td>
                            <td class="numeric">{{ "%.2f"|format(player.actual_points) }}</td>
                            <td class="numeric">{{ "%.2f"|format(player.expected_points_per_90) }}</td>
                            <td class="numeric">{{ "%.2f"|format(player.actual_points_per_90) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
            {% if page > 1 %}
            <a href="/?position={{ selected_position }}&mins={{ mins_threshold }}&games={{ time_period }}&sort={{ sort_by }}&order={{ sort_order }}&team={{ selected_team }}&price_max={{ price_max }}&page={{ page - 1 }}" class="page-btn">← Previous</a>
            {% else %}
            <span class="page-btn disabled">← Previous</span>
            {% endif %}
            
            <span class="page-info">Page {{ page }} of {{ position_data.total_pages }}</span>
            
            {% if page < position_data.total_pages %}
            <a href="/?position={{ selected_position }}&mins={{ mins_threshold }}&games={{ time_period }}&sort={{ sort_by }}&order={{ sort_order }}&team={{ selected_team }}&price_max={{ price_max }}&page={{ page + 1 }}" class="page-btn">Next →</a>
            {% else %}
            <span class="page-btn disabled">Next →</span>
            {% endif %}
        </div>
    </div>

    <script>
        const maxGames = {{ max_games }};
        let changeTimeout;

        function toggleFutureWindow(pill) {
            const isOn = pill.getAttribute('data-on') === 'true';
            const nowOn = !isOn;
            pill.setAttribute('data-on', nowOn);
            pill.querySelector('.pill-label').textContent = nowOn ? 'On' : 'Off';
            document.getElementById('future-window-item').style.display = nowOn ? 'flex' : 'none';
            applyFilters();
        }

        // ── helpers ──────────────────────────────────────────────────────────

        function updateLabel(id, text) {
            document.getElementById(id).textContent = text;
        }

        function updateGamesLabel(value) {
            const suffix = (value == 1) ? ' Game' : ' Games';
            const all    = (value == maxGames) ? ' (All)' : '';
            updateLabel('games-value', value + suffix + all);
        }

        function scheduleApply() {
            clearTimeout(changeTimeout);
            changeTimeout = setTimeout(applyFilters, 500);
        }

        let lastPosition = '{{ selected_position }}';

        // ── main navigate ────────────────────────────────────────────────────

        function applyFilters() {
            clearTimeout(changeTimeout);
            const currentPosition = document.getElementById('position-dropdown').value;
            const positionChanged = currentPosition !== lastPosition;
            const adjustOn = document.getElementById('adjust-difficulty-toggle').getAttribute('data-on') === 'true';

            const params = new URLSearchParams({
                position:          currentPosition,
                team:              document.getElementById('team-dropdown').value,
                mins:              document.getElementById('mins-slider').value,
                games:             document.getElementById('games-slider').value,
                adjust_difficulty: adjustOn,
                horizon:           document.getElementById('future-slider').value,
                sort:              '{{ sort_by }}',
                order:             '{{ sort_order }}',
                page:              1,
            });

            // Only carry price_max if position hasn't changed — otherwise let
            // the backend reset it to the new position's maximum
            if (!positionChanged) {
                params.set('price_max', parseFloat(document.getElementById('price-slider').value).toFixed(1));
            }

            window.location.href = '/?' + params.toString();
        }

        // ── column sort ──────────────────────────────────────────────────────

        function sortTable(column) {
            const currentSort  = '{{ sort_by }}';
            const currentOrder = '{{ sort_order }}';
            const adjustOn = document.getElementById('adjust-difficulty-toggle').getAttribute('data-on') === 'true';

            let newSort  = column;
            let newOrder = 'desc';

            if (currentSort === column) {
                if (currentOrder === 'desc') {
                    newOrder = 'asc';
                } else {
                    newSort  = 'expected_points';
                    newOrder = 'desc';
                }
            }

            const params = new URLSearchParams({
                position:          document.getElementById('position-dropdown').value,
                team:              document.getElementById('team-dropdown').value,
                mins:              document.getElementById('mins-slider').value,
                games:             document.getElementById('games-slider').value,
                price_max:         parseFloat(document.getElementById('price-slider').value).toFixed(1),
                adjust_difficulty: adjustOn,
                horizon:           document.getElementById('future-slider').value,
                sort:              newSort,
                order:             newOrder,
                page:              1,
            });
            window.location.href = '/?' + params.toString();
        }
    </script>
</body>
</html>